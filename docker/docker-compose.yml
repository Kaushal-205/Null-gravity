version: "3.8"

# Zcash-Aztec Bridge Infrastructure
# Uses devnet.5 with external Anvil

services:
  # ============================================================
  # Anvil - Local Ethereum L1
  # ============================================================
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: anvil
    entrypoint: [ "anvil" ]
    command: [ "--host", "0.0.0.0", "--port", "8545", "--chain-id", "31337", "--accounts", "10", "--balance", "10000", "--block-time", "12" ]
    ports:
      - "8545:8545"
    healthcheck:
      test: [ "CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545" ]
      interval: 2s
      timeout: 2s
      retries: 10
    networks:
      - bridge-network

  # ============================================================
  # Aztec Sandbox - PXE + Node
  # ============================================================
  aztec-sandbox:
    image: aztecprotocol/aztec:3.0.0-devnet.5
    container_name: aztec-sandbox
    command: start --sandbox
    environment:
      - ETHEREUM_HOSTS=http://anvil:8545
      - L1_CHAIN_ID=31337
    ports:
      - "8080:8080"
    depends_on:
      anvil:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/status" ]
      interval: 10s
      timeout: 5s
      retries: 60
      start_period: 120s
    networks:
      - bridge-network

  # ============================================================
  # Lightwalletd (Optional - for Zcash integration)
  # ============================================================
  lightwalletd:
    image: electriccoinco/lightwalletd:latest
    container_name: lightwalletd
    command: [ "--grpc-bind-addr", "0.0.0.0:9067", "--no-tls", "--zcash-conf-path", "/etc/zcash/zcash.conf" ]
    volumes:
      - lightwalletd-data:/var/lib/lightwalletd
      - ./zcash.conf:/etc/zcash/zcash.conf:ro
    ports:
      - "9067:9067"
    profiles:
      - zcash
    networks:
      - bridge-network

  # ============================================================
  # Sentinel AVS (Optional - Bridge Operator)
  # ============================================================
  sentinel:
    build:
      context: ../sentinel
      dockerfile: Dockerfile
    container_name: sentinel
    environment:
      - RUST_LOG=info
      - LIGHTWALLETD_URL=http://lightwalletd:9067
      - L1_RPC_URL=http://anvil:8545
      - SERVICE_MANAGER_ADDRESS=${SERVICE_MANAGER_ADDRESS}
      - OPERATOR_PRIVATE_KEY=${OPERATOR_PRIVATE_KEY}
      - VAULT_VIEWING_KEY=${VAULT_VIEWING_KEY}
      - VAULT_ADDRESS=${VAULT_ADDRESS}
    depends_on:
      aztec-sandbox:
        condition: service_healthy
    profiles:
      - sentinel
    networks:
      - bridge-network

networks:
  bridge-network:
    driver: bridge

volumes:
  lightwalletd-data:
